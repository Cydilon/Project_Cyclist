# installing packages and load tidyverse, dplyr
install.packages("tidyverse")
install.packages("lubridate")
install.packages("dplyr")
library(tidyverse)
library(lubridate)
library(dplyr)

## 1. Uploading the data in to R

# upload the data 
data_202009 <- read.csv("202009-divvy-tripdata.csv")
data_202010 <- read.csv("202010-divvy-tripdata.csv")
data_202011 <- read.csv("202011-divvy-tripdata.csv")
data_202012 <- read.csv("202012-divvy-tripdata.csv")
data_202101 <- read.csv("202101-divvy-tripdata.csv")
data_202102 <- read.csv("202102-divvy-tripdata.csv")
data_202103 <- read.csv("202103-divvy-tripdata.csv")
data_202104 <- read.csv("202104-divvy-tripdata.csv")
data_202105 <- read.csv("202105-divvy-tripdata.csv")
data_202106 <- read.csv("202106-divvy-tripdata.csv")
data_202107 <- read.csv("202107-divvy-tripdata.csv")
data_202108 <- read.csv("202108-divvy-tripdata.csv")

## 2. Wrangle the data and merge into a single data frame


# before merge into a single data frame it is important to match the colnames, using colnames() to compare each other
colnames(data_202009)
colnames(data_202010)
colnames(data_202011)
colnames(data_202012)
colnames(data_202101)
colnames(data_202102)
colnames(data_202103)
colnames(data_202104)
colnames(data_202104)
colnames(data_202105)
colnames(data_202106)
colnames(data_202107)
colnames(data_202108)


# using str() to see the type of the columns
str(data_202009)
str(data_202010)
str(data_202011)
str(data_202012)
str(data_202101)
str(data_202102)
str(data_202103)
str(data_202104)
str(data_202104)
str(data_202105)
str(data_202106)
str(data_202107)
str(data_202108)

# problem with the data after merged, so ride_length before merging
data_202009$ride_length <- difftime(data_202009$ended_at, data_202009$started_at)
data_202010$ride_length <- difftime(data_202010$ended_at, data_202010$started_at)
data_202011$ride_length <- difftime(data_202011$ended_at, data_202011$started_at)
data_202012$ride_length <- difftime(data_202012$ended_at, data_202012$started_at)
data_202101$ride_length <- difftime(data_202101$ended_at, data_202101$started_at)
data_202102$ride_length <- difftime(data_202102$ended_at, data_202102$started_at)
data_202103$ride_length <- difftime(data_202103$ended_at, data_202103$started_at)
data_202104$ride_length <- difftime(data_202104$ended_at, data_202104$started_at)
data_202105$ride_length <- difftime(data_202105$ended_at, data_202105$started_at)
data_202106$ride_length <- difftime(data_202106$ended_at, data_202106$started_at)
data_202107$ride_length <- difftime(data_202107$ended_at, data_202107$started_at)
data_202108$ride_length <- difftime(data_202108$ended_at, data_202108$started_at)


# change types if nessessary, using mutate(dataframe, new_name = as.type(old_name))
# data_202012, data_202101, data_202102, data_202103, data_202104, data_202105, data_202106, data_202107, data_202108 - start_station_id and end_station_id is chr but should be int

data_202012 <- mutate(data_202012, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202101 <- mutate(data_202101, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202102 <- mutate(data_202102, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202103 <- mutate(data_202103, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202104 <- mutate(data_202104, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202105 <- mutate(data_202105, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202106 <- mutate(data_202106, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202107 <- mutate(data_202107, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))
data_202108 <- mutate(data_202108, start_station_id = as.integer(start_station_id), end_station_id = as.integer(end_station_id))


# merge all rows together, stacking all data into one big data frame
data_merged <- bind_rows(data_202009, data_202010, data_202011, data_202012, data_202101, data_202102, data_202103, data_202104, data_202105, data_202106, data_202107, data_202108)

# remove lat, lng because not use in this case study 
data_merged <- data_merged %>% 
  select(-c(start_lat, start_lng, end_lat, end_lng))

## 3. clean and add data to prepare for the analysis

# inspect the new created data frame
head(data_merged)
str(data_merged)
glimpse(data_merged)
colnames(data_merged)


# before that add columns to the list the data, month, year, day and year of each ride
data_merged$date <- as.Date(data_merged$started_at)
data_merged$month <- format(as.Date(data_merged$date), "%m")
data_merged$day <- format(as.Date(data_merged$date), "%d")
data_merged$year <- format(as.Date(data_merged$date), "%Y")
data_merged$day_of_week <- format(as.Date(data_merged$date), "%A")


# for the analysis some column is needed, such as ride_length and station_usage
data_merged$ride_length <- difftime(data_merged$ended_at, data_merged$started_at)
data_merged$ride_length_minute <- data_merged$ride_length / 60

#inspect the new data_structure
str(data_merged)

#Convert ride_length from factor to numeric so the calculation function properly
is.factor(data_merged$ride_length)
data_merged$ride_length <- as.numeric(as.character(data_merged$ride_length))
is.numeric(data_merged$ride_length)


# clean the data; we should not have any negative rides, caused by systemerror
data_cleaned <- data_merged[!(data_merged$start_station_name == "HQ QR" | data_merged$ride_length<0),]
# remove duplicats
data_cleaned <- data_merged[!duplicated(data_merged$ride_id), ]
print(paste("Removed", nrow(data_merged) - nrow(data_cleaned), "duplicated rows"))


#saving the result as a CSV file
data_cleaned %>% 
  write.csv("C:\\Users\\LunWu\\Documents\\Capstone\\Case Study 1_Cyclist\\cyclist_tripdata_clean.csv")


